# ============================================================================
# IMPORTANT: This is a TEMPLATE file!
#
# Before flashing, you MUST replace ALL placeholders with your actual values:
#   1. WiFi SSID and password
#   2. API encryption key (generate with: esphome config-wizard)
#   3. OTA password (any secure password)
#   4. Fallback hotspot password
#
# The compilation will FAIL if you don't replace these placeholders.
# This is a safety feature to prevent accidentally using default credentials.
# ============================================================================

esphome:
  name: great-room-led
  friendly_name: Great Room LED
  # Safety check: Prevent flashing with placeholder credentials
  on_boot:
    - priority: -100
      then:
        - logger.log:
            format: "Device started successfully with custom configuration"
            level: INFO

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: arduino

# Enable logging
logger:

# Enable Home Assistant API
# Generate a key with: esphome config-wizard
api:
  encryption:
    key: "REPLACE_ME_YOUR_API_KEY_32_CHARS_LONG!!"

ota:
  platform: esphome
  password: "REPLACE_ME_YOUR_OTA_PASSWORD"

# ============================================================================
# CRITICAL: Replace with YOUR WiFi credentials!
# Example:
#   ssid: "MyHomeNetwork"
#   password: "MySecurePassword123"
# ============================================================================
wifi:
  ssid: "REPLACE_ME_YOUR_WIFI_SSID"
  password: "REPLACE_ME_YOUR_WIFI_PASSWORD"

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Light-Dimmer Fallback Hotspot"
    password: "REPLACE_ME_FALLBACK_PASSWORD"

captive_portal:

# Web server on port 80
web_server:
  port: 80
  auth:
    username: admin
    password: admin

# CRITICAL FIX: zero_means_zero forces true OFF at 0%
# Without this, the dimmer stays at ~20% minimum brightness
output:
  - platform: ledc
    pin: GPIO03
    id: gpio_03
    frequency: "1220Hz"  # 1220Hz, 2441Hz, 4882Hz
    zero_means_zero: true  # â† This line forces true OFF at 0%

light:
  - platform: monochromatic
    output: gpio_03
    name: "ESP32-C3"

# Current & Power Monitoring
# IMPORTANT: GPIO04 is a placeholder - verify actual current sense pin from hardware schematic
# See: https://github.com/krida0electronics/hass for hardware details
sensor:
  - platform: uptime
    name: "Great Room LED Uptime"
    update_interval: 60s

  - platform: wifi_signal
    name: "Great Room LED WiFi Signal"
    update_interval: 60s

  # ADC for current sensing - VERIFY PIN WITH HARDWARE SCHEMATIC
  - platform: adc
    pin: GPIO04  # PLACEHOLDER - check krida0electronics schematic
    name: "Great Room LED Current Raw"
    update_interval: 1s
    attenuation: 11db
    internal: true
    id: current_adc

  # Calculate actual current from ADC
  - platform: template
    name: "Great Room LED Current"
    id: led_current
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 2
    update_interval: 1s
    lambda: |-
      float voltage = id(current_adc).state;
      float current = (voltage / 3.3) * 30.0;  // Calibrate based on actual sensor
      return current;

  # Calculate power
  - platform: template
    name: "Great Room LED Power"
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    update_interval: 1s
    lambda: |-
      return id(led_current).state * 120.0;  // Adjust voltage if not US

# Binary sensor - true if current is flowing
binary_sensor:
  - platform: template
    name: "Great Room LED Actually On"
    lambda: |-
      return id(led_current).state > 0.1;
    device_class: power
