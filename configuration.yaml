# Home Assistant Configuration with KNX Integration
# Updated for modern HA version

homeassistant:
  name: "Casa Apertura"
  latitude: 39.7392
  longitude: -104.9903
  elevation: 1609
  unit_system: metric
  time_zone: America/Denver
  currency: USD
  country: US

# Configure a default setup of Home Assistant (frontend, api, etc)
default_config:

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

# HTTP Configuration
http:
  server_port: 8123
  ip_ban_enabled: true
  login_attempts_threshold: 5

# NOTE: To access ESP32 web interface directly, use: http://192.168.0.118
# Login: admin / admin

# Template Light - Coordinates Shelly relay + ESP32 dimmer with 90% brightness limit
# Protects 3.3A circuit and ensures true OFF via Shelly hard cutoff
template:
  - light:
      - unique_id: great_room_led_limited_90pct
        name: "Great Room LED (Limited)"
        default_entity_id: light.great_room_limited

        # State tracking - light is on if Shelly relay is on AND dimmer is on
        state: "{{ is_state('switch.shelly1pm_84cca8a1148d', 'on') and is_state('light.do_not_use_esp32_c3', 'on') }}"
        level: "{{ state_attr('light.do_not_use_esp32_c3', 'brightness') | int }}"

        # Turn on action - enable Shelly relay, then set dimmer brightness (max 90%)
        turn_on:
          # Step 1: Turn on Shelly relay to enable power
          - action: switch.turn_on
            target:
              entity_id: switch.shelly1pm_84cca8a1148d
          # Step 2: Wait for LED controller to boot
          - delay:
              milliseconds: 200
          # Step 3: Set ESP32 dimmer brightness (capped at 230/255 = 90%)
          - action: light.turn_on
            data_template:
              entity_id: light.do_not_use_esp32_c3
              brightness: >
                {% if brightness is defined %}
                  {% set b = brightness | int %}
                  {% if b > 230 %}230{% else %}{{ b }}{% endif %}
                {% else %}
                  230
                {% endif %}

        # Turn off action - dim to 0%, then hard cut power via Shelly
        turn_off:
          # Step 1: Turn off ESP32 dimmer
          - action: light.turn_off
            data:
              entity_id: light.do_not_use_esp32_c3
          # Step 2: Wait briefly
          - delay:
              milliseconds: 100
          # Step 3: Hard cut power via Shelly relay
          - action: switch.turn_off
            target:
              entity_id: switch.shelly1pm_84cca8a1148d

        # Set level action - ensure Shelly is on, then adjust brightness (max 90%)
        set_level:
          # Step 1: Make sure Shelly relay is on
          - action: switch.turn_on
            target:
              entity_id: switch.shelly1pm_84cca8a1148d
          # Step 2: Brief delay if relay was off
          - delay:
              milliseconds: 200
          # Step 3: Set dimmer brightness (capped at 230)
          - action: light.turn_on
            data_template:
              entity_id: light.do_not_use_esp32_c3
              brightness: >
                {% if brightness is defined %}
                  {% if brightness > 230 %}230{% else %}{{ brightness }}{% endif %}
                {% else %}
                  230
                {% endif %}

# Include automations
automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

# Shell commands for downloading ESPHome configs from GitHub (PRIVATE REPO)
# SETUP:
#   1. Copy download_esphome_config.sh to /config/scripts/
#   2. Create /config/.github_token with your GitHub Personal Access Token
#   3. chmod +x /config/scripts/download_esphome_config.sh
shell_command:
  download_great_room_yaml: '/config/scripts/download_esphome_config.sh great-room'
  download_all_esphome_yamls: '/config/scripts/download_esphome_config.sh all'

# Logging
logger:
  default: warn
  logs:
    xknx: debug
    homeassistant.components.knx: debug

# Recorder - limit database size
recorder:
  purge_keep_days: 7
  include:
    domains:
      - light
      - switch
      - cover
      - media_player
      - sensor
      - binary_sensor
