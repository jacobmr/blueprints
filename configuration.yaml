# Home Assistant Configuration with KNX Integration
# Updated for modern HA version

homeassistant:
  name: "Casa Apertura"
  latitude: 39.7392
  longitude: -104.9903
  elevation: 1609
  unit_system: metric
  time_zone: America/Denver
  currency: USD
  country: US

# Configure a default setup of Home Assistant (frontend, api, etc)
default_config:

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

# HTTP Configuration
http:
  server_port: 8123
  ip_ban_enabled: true
  login_attempts_threshold: 5

# NOTE: To access ESP32 web interface directly, use: http://192.168.0.118
# Login: admin / admin

# Template Light - Limits Great Room LED to 90% brightness (230/255) to protect 3.3A circuit
template:
  - light:
      - unique_id: great_room_led_limited_90pct
        name: "Great Room LED (Limited)"
        default_entity_id: light.great_room_limited

        # State tracking
        state: "{{ is_state('light.do_not_use_esp32_c3', 'on') }}"
        level: "{{ state_attr('light.do_not_use_esp32_c3', 'brightness') | int }}"

        # Turn on action - limit brightness to 230 max (90%)
        turn_on:
          - action: light.turn_on
            data_template:
              entity_id: light.do_not_use_esp32_c3
              brightness: >
                {% if brightness is defined %}
                  {% set b = brightness | int %}
                  {% if b > 230 %}230{% else %}{{ b }}{% endif %}
                {% else %}
                  230
                {% endif %}

        # Turn off action
        turn_off:
          - action: light.turn_off
            data:
              entity_id: light.do_not_use_esp32_c3

        # Set level action - also limit to 230 max
        set_level:
          - action: light.turn_on
            data_template:
              entity_id: light.do_not_use_esp32_c3
              brightness: >
                {% if brightness is defined %}
                  {% if brightness > 230 %}230{% else %}{{ brightness }}{% endif %}
                {% else %}
                  230
                {% endif %}

# Include automations
automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

# Shell commands for downloading ESPHome configs from GitHub (PRIVATE REPO)
# SETUP:
#   1. Copy download_esphome_config.sh to /config/scripts/
#   2. Create /config/.github_token with your GitHub Personal Access Token
#   3. chmod +x /config/scripts/download_esphome_config.sh
shell_command:
  download_great_room_yaml: '/config/scripts/download_esphome_config.sh great-room'
  download_all_esphome_yamls: '/config/scripts/download_esphome_config.sh all'

# Logging
logger:
  default: warn
  logs:
    xknx: debug
    homeassistant.components.knx: debug

# Recorder - limit database size
recorder:
  purge_keep_days: 7
  include:
    domains:
      - light
      - switch
      - cover
      - media_player
      - sensor
      - binary_sensor
